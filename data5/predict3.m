%非线性SVM
%预测函数
function nonlinear = predict3(train_name,kertype,gamma,C)
 %-----------------------training data ready------------------------
    train = train_name;
    [m,n] = size(train);
    train_x = train(:,1:n-1);
    train_y = train(:,n);
    pos = find(train_y == 1);
    neg = find(train_y == -1);
    plot(train_x(pos,1),train_x(pos,2),'k+');
    hold on;
    plot(train_x(neg,1),train_x(neg,2),'g^');
    hold on;
    
    %-----------------------training model--------------------------
    %二次规划用来求解问题，使用quadprog
     K = kernel(train_x,train_x,kertype,gamma);
%     H = (train_y*train_y').*K;    
%     f = -ones(m,1); 
%     A = [];
%     b = [];
%     Aeq = train_y'; 
%     beq = 0;
%     lb = zeros(m,1); 
%     if C == 0
%         ub = [];
%     else
%         ub = C*ones(m,1);
%     end
%     a = quadprog(H,f,A,b,Aeq,beq,lb,ub);
%     epsilon = 1e-5;
%     %查找支持向量
%     sv_index = find(abs(a)> epsilon);
%     Xsv = train_x(sv_index,:);
%     Ysv = train_y(sv_index);
%     svnum = length(sv_index);

    %计算得到支持向量
    train_svm = svmTrain(train_x,train_y,kertype,gamma,C);
%    Xsv=train_svm.Xsv;
    Ysv=train_svm.Ysv;
    svnum = train_svm.len;
    %make classfication predictions over a grid of values
    xplot = linspace(min(train_x(:,1)),max(train_x(:,1)),100)';
    yplot = linspace(min(train_x(:,2)),max(train_x(:,2)),100)';
    [X,Y] = meshgrid(xplot,yplot);%最大值控制着等高线在几乘几范围画出来
    vals = zeros(size(X));

    %calculate decision value
    %拉格朗日乘子α
    train_a = train_svm.a;
    sum_b = 0;
    for k = 1:svnum
        sum = 0;
        for i = 1:m
            %根据决策函数式得到
            sum = sum + train_a(i,1)*train_y(i,1)*K(i,k);
        end 
        %根据《统计学习方法》p142
        sum_b = sum_b + Ysv(k) - sum;
    end
    train_b = sum_b/svnum;%b总和除以支持向量数量
    
    %根据决策函数计算函数值得到等高线坐标
    for i = 1:100
        for j = 1:100
            x_y = [X(i,j),Y(i,j)];
            sum = 0;
            for k = 1:m
                sum = sum + train_a(k,1)*train_y(k,1)*exp(-gamma*norm(train_x(k,:)-x_y)^2);
            end
            vals(i,j) = sum + train_b;
        end 
    end

    %plot the SVM boundary
    colormap bone;
    contour(X,Y,vals,[0 0],'LineWidth',4);
    title(['\gamma = ',num2str(gamma)]);
end
